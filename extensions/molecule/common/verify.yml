---
- name: Install and configure beat packages
  hosts: all:!localhost
  become: true
  roles:
    - pokerops.monitoring.monitoring
  tasks:
    - name: Gather service facts
      ansible.builtin.service_facts:

    - name: Verify beats daemons
      ansible.builtin.assert:
        that:
          - service_installed
          - service_running
          - service_enabled
        fail_msg: "{{ fail_uninstalled if not service_installed else (fail_offline if not service_running else fail_disabled) }}"
      vars:
        fail_uninstalled: "{{ item }} service is not installed"
        fail_offline: "{{ item }} service is not running"
        fail_disabled: "{{ item }} service is not enabled"
        service_installed: "{{ item + '.service' in ansible_facts.services }}"
        service_running: "{{ ansible_facts.services[item + '.service'].state == 'running' }}"
        service_enabled: "{{ ansible_facts.services[item + '.service'].status == 'enabled' }}"
      loop:
        - filebeat
        - metricbeat
        - heartbeat-elastic

    - name: Pause for 15 seconds to allow beats to send data
      ansible.builtin.pause:
        seconds: 15

    - name: Slurp metricbeat events
      ansible.builtin.slurp:
        src: /var/log/vector/metricbeat.log
      register: metricbeat_process_log

    - name: Decode metricbeat events
      ansible.builtin.set_fact:
        metricbeat_events: "{{ _event_lines | map('from_json') }}"
      vars:
        _event_lines: "{{ metricbeat_process_log.content | b64decode | split('\n') | reject('equalto', '') }}"

    - name: Decode process events
      ansible.builtin.set_fact:
        metricbeat_processes_systemd: "{{ metricbeat_processes_all | selectattr('process.executable', 'search', 'systemd$') | list }}"
      vars:
        metricbeat_processes_all: "{{ metricbeat_events | selectattr('metricset.name', 'equalto', 'process') | list }}"

    - name: Verify metricbeat process monitoring
      ansible.builtin.assert:
        that: metricbeat_processes_systemd | length > 0
        success_msg: "{{ metricbeat_processes_systemd | length }} events found for systemd processes"
        fail_msg: "{{ metricbeat_processes_systemd | length }} events found for systemd processes"

    - name: Check that the demolog.log exists
      stat:
        path: /var/log/vector/demolog.log
      register: demolog_stat_result

    - name: Assert that the demolog.log file exists
      ansible.builtin.assert:
        that:
          - demolog_stat_result.stat.exists
        success_msg: "demolog.log file exists"
        fail_msg: "demolog.log file does not exist"
